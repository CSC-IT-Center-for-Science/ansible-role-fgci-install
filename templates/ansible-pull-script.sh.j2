#!/bin/bash
# This file is created with ansible-role-fgci-install on the install node
#
# It is a script to run ansible-pull on an FGCI compute node
# It is first grabbed with curl during kickstart
# It's initially set to execute every 15 minutes
# Local.yml itself changes cron interval after execution.

# writes to syslog and stderr with tag ansible-pull
loggercmd="/usr/bin/logger -s -t ansible-pull"
export http_proxy="http://{{ int_gateway }}:3128"
export https_proxy=$http_proxy
export no_proxy="localhost,{{ pull_install_ip }},raw.githubusercontent.com"
time=$[ ( $RANDOM % {{ ansible_pull_sleep }} )  + 1 ]
lockdir="/var/lock/ansible-pull"

# Setup the ansible-pull fgci work dir
mkdir -p /root/.ansible/pull/$HOSTNAME
cd /root/.ansible/pull/$HOSTNAME

## One ansible-pull at a time
if mkdir "$lockdir"
then
        LOCK="1" # and the script continues
else
        $loggercmd "cannot acquire lock, giving up on $lockdir"
        LOCK="0"
        exit 1
fi
##

# Bring Up Ib0
/usr/sbin/ifup ib0

# Sleep a bit
/bin/sleep "$time"s

# Clone or update the fgci-ansible repo
git config --get remote.origin.url |grep {{ pull_install_ip }} >/dev/null
if [ "$?" != 0 ]; then
    cd ..
    rm -rf $HOSTNAME
    /usr/bin/git clone http://{{ pull_install_ip }}:8080/github.com/CSC-IT-Center-for-Science/fgci-ansible.git $HOSTNAME
if [ "$?" != 0 ]; then
        $loggercmd "error: with 'git clone http://{{ pull_install_ip }}:8080/github.com/CSC-IT-Center-for-Science/fgci-ansible.git .' PWD=$PWD rc=$?"
fi
    cd $HOSTNAME
else
# If the .git directory exists then only run git pull
/usr/bin/git pull
if [ "$?" != 0 ]; then
        $loggercmd "error: git pull in PWD=$PWD rc=$?"
fi
fi

# Mirror in the group_vars - they are copied to install node's www with the fgci-install tag and role for install node.
# Wget assumes we are in $HOME/.ansible/pull/$HOSTNAME when running
/usr/bin/wget --random-wait $time --no-host-directories --mirror --accept=example,yml,fgci-default-packages http://{{ pull_install_ip }}/group_vars

# Install all the ansible role dependencies
/usr/bin/curl -O http://{{ pull_install_ip }}/requirements_mirror.yml
/usr/bin/ansible-galaxy install -r requirements_mirror.yml -f -i
if [ "$?" != 0 ]; then
        $loggercmd "error: installing ansible requirements rc=$?"
fi

# Get the ansible hosts file 
/usr/bin/curl http://{{ pull_install_ip }}/hosts > /root/hosts
if [ "$?" != 0 ]; then
        $loggercmd "error: curling http://{{ pull_install_ip }}/hosts rc=$?"
fi

# customizable random delay in seconds, fgci-ansible/local.yml playbook, master branch and /root/hosts inventory file
/usr/bin/ansible-pull -s $time -U http://{{ pull_install_ip }}:8080/github.com/CSC-IT-Center-for-Science/fgci-ansible.git -C {{ ansible_pull_branch }} -i /root/hosts
$loggercmd "info: ansible-pull -s $time -U https://{{ pull_install_ip }}:8080/github.com/CSC-IT-Center-for-Science/fgci-ansible.git -C {{ ansible_pull_branch }} -i /root/hosts exited with rc=$?"

# Remove lockdir when we are done but before we update ourselves.
rmdir $lockdir

# Grab the latest ansible-pull-script.sh
/usr/bin/ansible -i /root/hosts -m get_url -a "url=http://{{ pull_install_ip }}/ansible-pull-script.sh dest=/usr/local/bin/ mode=0755" localhost
if [ "$?" != 0 ]; then
        $loggercmd "error: ansible -i /root/hosts -m get_url -a 'url=http://{{ pull_install_ip }}/ansible-pull-script.sh dest=/usr/local/bin/' localhost failed with rc=$?"
fi
